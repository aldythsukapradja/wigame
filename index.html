<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RMO 360 (pilot) — Voidage Balance Simulator</title>
  <style>
    :root{ --bg:#0a0f14; --panel:#0f1720; --ink:#e5f4ee; --muted:#93a3a1; --accent1:#00d68f; --accent2:#1cf5b2; --warn:#ffbe0b; --bad:#ff3b30; --good:#35ff9a; --grid:#11212b; }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 70% -10%, rgba(28,245,178,0.15), transparent 60%),radial-gradient(900px 600px at 10% 110%, rgba(0,214,143,0.12), transparent 60%),#0a0f14;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:16px}
    header{position:relative;padding:20px;border-radius:20px;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,.06)}
    h1{margin:8px 0 0;font-size:28px;letter-spacing:.4px}
    .tagline{color:var(--muted);margin-top:6px}
    .capsule{position:absolute;top:-14px;left:20px;padding:8px 14px;border-radius:999px;font-weight:600;letter-spacing:.3px;font-size:14px;background:linear-gradient(135deg,#0f3d2e,#0b2b22);box-shadow:0 0 0 1px rgba(0,214,143,.2) inset,0 0 20px rgba(28,245,178,.35);text-decoration:none;color:#b6ffe5;transition:transform .18s,box-shadow .18s}
    .capsule:hover{transform:translateY(-1px);box-shadow:0 0 0 1px rgba(28,245,178,.5) inset,0 8px 26px rgba(28,245,178,.45)}

    /* Layout: chart first, controls second; side-by-side on desktop, stacked on mobile */
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    @media (min-width: 980px){ .grid{grid-template-columns:1fr 360px} }

    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;position:relative;overflow:hidden}
    .card h2{margin:0 0 12px;font-size:16px;letter-spacing:.4px;color:#ccffee}

    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid rgba(255,255,255,.08);border-radius:999px;font-size:12px;color:#c9fbe9}

    .meters{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .meter{background:#0b131a;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
    .meter .label{font-size:12px;color:#a8c7bd;margin-bottom:4px}
    .meter .value{font-weight:700;font-size:18px}

    .health{height:14px;background:#0b131a;border:1px solid rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
    .health>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .2s}

    .gauge{display:flex;align-items:center;gap:8px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%}

    canvas{display:block;width:100%;height:300px;background:linear-gradient(0deg,transparent 24px,var(--grid) 25px),linear-gradient(90deg,transparent 24px,var(--grid) 25px);background-size:100% 50px,50px 100%;border-radius:12px;border:1px solid rgba(255,255,255,.06)}

    .controls{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:980px){.controls{grid-template-columns:1fr}}
    button{appearance:none;border:none;background:#0f1e18;color:#caffef;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:600;letter-spacing:.3px;cursor:pointer}
    button:hover{filter:brightness(1.15)}
    button.secondary{background:#131722}

    .status{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1)}
    .badge.good{color:#0f0;border-color:rgba(0,255,128,.35);background:rgba(0,255,128,.06)}
    .badge.warn{color:#ffbe0b;border-color:rgba(255,190,11,.35);background:rgba(255,190,11,.08)}
    .badge.bad{color:#ff3b30;border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08)}

    .legend{display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:#b8d7cd}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .key{width:14px;height:3px;border-radius:2px;display:inline-block}
    .k-pressure{background:#9bfdd7}
    .k-target{background:linear-gradient(90deg,transparent 40%,rgba(0,214,143,.5) 40%,rgba(0,214,143,.5) 60%,transparent 60%)}

    footer{margin-top:20px;color:#88b7aa;font-size:12px;text-align:center}
    a{color:#8bf7d1}

    /* Mobile-friendly pads */
    .controlPads{display:grid;grid-template-columns:1fr;gap:12px}
    .pad{background:#0b131a;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
    .padGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .bigBtn{appearance:none;border:none;background:#0f1e18;color:#eafff6;padding:18px 0;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:800;letter-spacing:.6px;font-size:22px;cursor:pointer;user-select:none;touch-action:manipulation}
    .bigBtn:active{transform:translateY(1px)}
    @media (pointer:coarse){.bigBtn{padding:22px 0;font-size:26px}}
  
    /* Alarm capsule */
    .alarm{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:linear-gradient(135deg,#3d0f10,#2b0b0d);color:#ffd7d7;border:1px solid rgba(255,59,48,.55);box-shadow:0 0 18px rgba(255,59,48,.35);font-weight:700}
    .alarm .mark{width:18px;height:18px;line-height:18px;border-radius:999px;background:#ff3b30;color:#fff;text-align:center;font-size:12px;font-weight:900}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="capsule" href="https://aldythsukapradja.github.io/Plan" target="_blank" rel="noopener">Milestones</a>
      <h1>RMO 360 (pilot) — Voidage Balance Simulator</h1>
      <div class="tagline">Keep <strong>VRR</strong> (Voidage Replacement Ratio) in the sweet spot by adjusting <strong>injection</strong>. Producer fluctuates ±3000 BOPD. Score climbs while VRR stays in the green band.</div>
    </header>

    <div class="grid">
      <!-- Chart FIRST -->
      <section class="card" id="chartCard">
        <h2>VRR Trend</h2>
        
        <div class="legend" style="margin-bottom:8px">
          <span><i class="key k-pressure"></i> VRR (%)</span>
          <span><i class="key k-target"></i> Target band</span>
        </div>
        <canvas id="chart" width="800" height="300" aria-label="VRR chart"></canvas>
        <div class="chartFooter" style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:10px">
          <div id="alarm" class="alarm" style="opacity:.35"><span class="mark">!</span><span id="alarmText">VRR OK (90–110%)</span></div>
          <div class="pill">Target band: <strong id="bandText">90–110 %</strong></div>
          <div class="pill">Fail limits: <strong>80 % / 120 %</strong></div>
          <div class="pill">Fail limits: <strong>80 % / 120 %</strong></div>
          <div class="pill">Disturbances: <strong>on</strong></div>
        </div>
      </section>

      <!-- Controls SECOND (side-by-side on desktop, below on mobile) -->
      <section class="card" id="controlsCard">
        <h2>Controls</h2>
        <div class="controlPads">
          <div class="pad">
            <div class="row">
              <label>Injector rate</label>
              <div class="pill"><span id="injVal">7000</span> BWIPD</div>
            </div>
            <div class="padGrid">
              <button class="bigBtn" id="injUp" aria-label="Increase injector">▲</button>
              <button class="bigBtn" id="injDown" aria-label="Decrease injector">▼</button>
            </div>
            <div class="row" style="margin-top:8px">
              <div class="pill">Producer (variable): <strong id="prodFixedVal">7000</strong> BWOPD</div>
            </div>
          </div>
        </div>

        <div class="meters" style="margin:10px 0 6px">
          <div class="meter">
            <div class="label">VRR (Voidage Replacement Ratio)</div>
            <div class="value"><span id="vrrNow">100</span> %</div>
          </div>
          <div class="meter">
            <div class="label">Score</div>
            <div class="value"><span id="score">0</span></div>
          </div>
        </div>

        <div class="gauge" id="gauge">
          <div class="dot" id="gDot" style="background:var(--good)"></div>
          <span id="gText">Stable</span>
        </div>

        <div class="health" style="margin-top:10px"><span id="healthBar"></span></div>

        <div class="controls" style="margin-top:12px">
          <button id="startBtn">Start</button>
          <button id="resetBtn" class="secondary">Reset</button>
        </div>

        <div class="status" id="status"></div>
      </section>
    </div>

    <footer>
      Tip: Keep injection near production to hold VRR ~100%. Scoring only while VRR stays in the green band.
    </footer>
  </div>

  <script>
    // ----- Simulation constants (slower dynamics) -----
    const dt = 0.05; // sim step (s)
    const stepsPerFrame = 1; // slower update

    // VRR setup
    const INJ_MIN = 2500; // BWIPD
    const INJ_MAX = 10000; // BWIPD
    const PROD_BASE = 7000; // BOPD
    const PROD_MIN = PROD_BASE - 3000; // 4000
    const PROD_MAX = PROD_BASE + 3000; // 10000
    const PROD_NOISE = 60; // stronger jitter per step for challenge // smaller jitter per step for slower feel
    const STEP = 100; // BWIPD per tap/interval

    const noiseAmp = 0.8; // VRR % jitter amplitude (reduced)

    // bands (in % VRR)
    const BAND_MIN = 90, BAND_MAX = 110;
    const FAIL_MIN = 80, FAIL_MAX = 120;

    // ----- State -----
    let inj = 7000; // BWIPD
    let prod = PROD_BASE; // BOPD (randomly varies)
    let P = 100; // VRR %
    let score = 0;
    let playing = false;
    let outOfBoundsFor = 0; // seconds out of fail bounds
    let tElapsed = 0; // seconds since start

    // UI elements
    const injVal = document.getElementById('injVal');
    const prodFixedValEl = document.getElementById('prodFixedVal');
    const vrrNow = document.getElementById('vrrNow');
    const scoreEl = document.getElementById('score');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const statusEl = document.getElementById('status');
    const gText = document.getElementById('gText');
    const gDot = document.getElementById('gDot');
    const bandText = document.getElementById('bandText');
    const healthBar = document.getElementById('healthBar');
    const alarmEl = document.getElementById('alarm');
    const alarmText = document.getElementById('alarmText');

    // Chart
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    const history = []; const maxPoints = 800;

    function setBadge(msg, type){
      const span = document.createElement('span');
      span.className = `badge ${type||''}`.trim();
      span.textContent = msg; statusEl.prepend(span);
      while(statusEl.children.length>5){ statusEl.removeChild(statusEl.lastChild); }
    }

    function clampInj(v){ return Math.max(INJ_MIN, Math.min(INJ_MAX, v)); }

    function updateUI(){
      injVal.textContent = Math.round(inj);
      prodFixedValEl.textContent = Math.round(prod);
      vrrNow.textContent = Math.round(P);
      scoreEl.textContent = Math.round(score);

      let st = 'Stable', col = 'var(--good)';
      if(P < BAND_MIN) { st='Low'; col='var(--warn)'; }
      if(P > BAND_MAX) { st='High'; col='var(--warn)'; }
      if(P < FAIL_MIN || P > FAIL_MAX){ st='Critical'; col='var(--bad)'; }
      gText.textContent = st; gDot.style.background = getComputedStyle(document.documentElement).getPropertyValue(col);

      // health vs 100%
      const norm = Math.max(0, 100 - Math.abs(P - 100));
      healthBar.style.width = Math.max(0, Math.min(100, norm)) + '%';

      // alarm capsule
      if(P < FAIL_MIN){
        alarmText.textContent = '⚠ Excessive Gas Production (VRR < 80%)';
        alarmEl.classList.remove('hidden');
      } else if(P > FAIL_MAX){
        alarmText.textContent = '⚠ Excessive Water Production (VRR > 120%)';
        alarmEl.classList.remove('hidden');
      } else {
        alarmEl.classList.add('hidden');
      }
    }

    function physicsStep(){
      // time
      tElapsed += dt;

      // producer random walk around base with gentle, bounded drift; volatility increases slowly over time
      const effNoise = PROD_NOISE * (1 + 1.0 * (1 - Math.exp(-tElapsed/35))); // ramps to 2x base
      prod += (PROD_BASE - prod) * 0.01 + (Math.random()*2-1) * effNoise;
      if(prod < PROD_MIN) prod = PROD_MIN + Math.random()*100;
      if(prod > PROD_MAX) prod = PROD_MAX - Math.random()*100;

      const desired = (inj / prod) * 100; // target VRR based on current producer
      const noise = (Math.random()*2-1) * noiseAmp;

      // response gain increases over time (faster as the game goes on), capped
      const responseGain = 0.06 + 0.10 * (1 - Math.exp(-tElapsed/30)); // -> ~0.16 max
      P += (desired - P) * responseGain + noise * dt * 5;

      if(P >= BAND_MIN && P <= BAND_MAX) score += dt * 8; // scoring

      if(P < FAIL_MIN || P > FAIL_MAX) outOfBoundsFor += dt; else outOfBoundsFor = Math.max(0, outOfBoundsFor - dt*0.5);

      history.push(P); if(history.length > maxPoints) history.shift();
    }

    function drawChart(){
      const w = canvas.width, h = canvas.height; ctx.clearRect(0,0,w,h);
      // target band
      const yMin = mapP(BAND_MAX, h), yMax = mapP(BAND_MIN, h);
      ctx.save(); ctx.globalAlpha = 0.25; ctx.fillStyle = '#00d68f'; ctx.fillRect(0, yMin, w, yMax - yMin); ctx.restore();
      // VRR line
      if(history.length>1){
        ctx.beginPath(); ctx.lineWidth = 2; ctx.strokeStyle = '#9bfdd7';
        for(let i=0;i<history.length;i++){ const x = (i/(maxPoints-1))*w; const y = mapP(history[i], h); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.stroke();
      }
      // current point
      ctx.beginPath(); ctx.fillStyle = '#eafff6'; const x = (history.length-1)/(maxPoints-1)*w; ctx.arc(x, mapP(P,h), 3, 0, Math.PI*2); ctx.fill();
    }

    function mapP(p,h){ const min=50, max=150; return h - (p-min)/(max-min)*h; }

    let raf; function loop(){
      for(let i=0;i<stepsPerFrame;i++) physicsStep(); updateUI(); drawChart();
      if(outOfBoundsFor > 5){ playing=false; setBadge('Game over: VRR stayed critical for >5s','bad'); startBtn.textContent='Resume'; cancelAnimationFrame(raf); return; }
      if(playing){ raf = requestAnimationFrame(loop); }
    }

    // Controls
    function changeRate(delta){ inj = clampInj(inj + delta); updateUI(); }
    function bindHold(btn, delta){
      let repeat; const start=()=>{ changeRate(delta); repeat=setInterval(()=>changeRate(delta),150); };
      const stop=()=>{ clearInterval(repeat); };
      btn.addEventListener('mousedown', start);
      btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); start(); }, {passive:false});
      ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>btn.addEventListener(ev, stop));
    }
    bindHold(document.getElementById('injUp'), +STEP);
    bindHold(document.getElementById('injDown'), -STEP);

    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowUp' || e.key.toLowerCase()==='w') changeRate(+STEP);
      if(e.key==='ArrowDown' || e.key.toLowerCase()==='s') changeRate(-STEP);
    });

    startBtn.addEventListener('click', ()=>{ playing = !playing; if(playing){ setBadge('Simulation running','good'); startBtn.textContent='Pause'; raf=requestAnimationFrame(loop);} else { setBadge('Paused','warn'); startBtn.textContent='Resume'; cancelAnimationFrame(raf);} });
    resetBtn.addEventListener('click', ()=>{ inj=7000; prod=PROD_BASE; P=100; score=0; outOfBoundsFor=0; history.length=0; updateUI(); drawChart(); startBtn.textContent='Start'; playing=false; setBadge('Reset',''); });

    // init
    bandText.textContent = `${BAND_MIN}–${BAND_MAX} %`; updateUI(); drawChart();
  </script>
</body>
</html>
